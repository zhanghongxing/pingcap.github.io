<!DOCTYPE html>




<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible"content="IE=edge">
<meta name="viewport"content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TiKV 源码解析系列 - Placement Driver | PingCAP</title>
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async src="https://download.pingcap.com/js/ga-analytics.js"></script>

<link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="canonical" href="https://www.pingcap.com/">
<meta name="description" content="Placement Driver (后续以 PD 简称) 是 TiDB 里面全局中心总控节点，它负责整个集群的调度，负责全局 ID 的生成，以及全局时间戳 TSO 的生成等。PD 还保存着整个集群 TiKV 的元信息，负责给 client 提供路由功能。">
<meta name="robots" content="noodp">
<meta name="keywords" content="SQL, HTAP, Open Source, Cloud-Native, NewSQL">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="website">
<meta property="og:title" content="TiKV 源码解析系列 - Placement Driver">
<meta property="og:description" content="Placement Driver (后续以 PD 简称) 是 TiDB 里面全局中心总控节点，它负责整个集群的调度，负责全局 ID 的生成，以及全局时间戳 TSO 的生成等。PD 还保存着整个集群 TiKV 的元信息，负责给 client 提供路由功能。">
<meta property="og:url" content="https://pingcap.com/blog-cn/placement-driver/">
<meta property="og:site_name" content="PingCAP">
<meta property="og:image" content="https://pingcap.com/images/pingcap-opengraph.jpg">
<meta property="og:image:secure_url" content="https://pingcap.com/images/pingcap-opengraph.jpg">
<meta name="twitter:card" content="summary">
<meta name="twitter:description" content="Placement Driver (后续以 PD 简称) 是 TiDB 里面全局中心总控节点，它负责整个集群的调度，负责全局 ID 的生成，以及全局时间戳 TSO 的生成等。PD 还保存着整个集群 TiKV 的元信息，负责给 client 提供路由功能。">
<meta name="twitter:title" content="TiKV 源码解析系列 - Placement Driver">
<meta name="twitter:site" content="@pingcap">
<meta name="twitter:image:src" content="https://pingcap.com/images/pingcap-opengraph.jpg">
<meta name="twitter:creator" content="@pingcap">


<script type="text/javascript" src="//script.crazyegg.com/pages/scripts/0076/9903.js" async="async"></script>


<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/www.pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/www.pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">

<link rel="preload" href="https://download.pingcap.com/js/jquery.min.js" as="script">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://download.pingcap.com/style/docsearch.min.css">


<link rel="stylesheet" href="https://download.pingcap.com/style/github-markdown.css">


<link rel="stylesheet" href="/css/doc.css">

        <script type="text/javascript">"/"===location.pathname&&"pingcap.github.io"===location.hostname&&(location.href="/en/")</script>
<link rel="preload"as="script"href="/js/app.js">
</head><body ><style type="text/css">
    .center-element {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        -webkit-transform: translate(-50%, -50%);
    }

    #page-loader {
        transform: translate(-50%, -50%) scale(0.6);
        -webkit-transform: translate(-50%, -50%) scale(0.6);
    }

    #hexagon {
        width: 60px;
        height: auto;
        overflow: visible;
        background-color: transparent;
    }

    #hexagon #hexagon-base,
    #hexagon #hexagon-line-animation {
        fill: transparent;
        stroke-miterlimit: 10;
        stroke-width: 4px;
    }

    #hexagon #hexagon-base {
        stroke: #cdd5e0;
    }

    #hexagon #hexagon-line-animation {
        stroke: #3a59f0;
        stroke-linecap: round;
        animation: dash 1.5s linear;
        animation-iteration-count: infinite;
    }

    @keyframes dash {
        0% {
            stroke-dasharray: 260.22 173.48;
            stroke-dashoffset: 0;
        }
        50% {
            stroke-dasharray: 1 431.7;
        }
        100% {
            stroke-dasharray: 260.22 173.48;
            stroke-dashoffset: -867.4;
        }
    }
</style>

<div id="page-loader" class="center-element">
    <svg id="hexagon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 129.78 150.37">
        <path id="hexagon-base" d="M-1665.43,90.94V35.83a15.09,15.09,0,0,1,6.78-12.59l48.22-31.83a15.09,15.09,0,0,1,16-.38L-1547,19.13a15.09,15.09,0,0,1,7.39,13V90.94a15.09,15.09,0,0,1-7.21,12.87l-47.8,29.24a15.09,15.09,0,0,1-15.75,0l-47.8-29.24A15.09,15.09,0,0,1-1665.43,90.94Z" transform="translate(1667.43 13.09)"/>
        <path id="hexagon-line-animation" d="M-1665.43,90.94V35.83a15.09,15.09,0,0,1,6.78-12.59l48.22-31.83a15.09,15.09,0,0,1,16-.38L-1547,19.13a15.09,15.09,0,0,1,7.39,13V90.94a15.09,15.09,0,0,1-7.21,12.87l-47.8,29.24a15.09,15.09,0,0,1-15.75,0l-47.8-29.24A15.09,15.09,0,0,1-1665.43,90.94Z" transform="translate(1667.43 13.09)"/>
    </svg>
</div>
<div id="page-content"style="display:none">
<header role="navigation" class="fixed-top">
    <div class="container">
        <a class="nav-brand" href="/index.html"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        <div class="nav-wrapper">
            <div class="navigation">
                <ul>
                <li ><a href="/docs-cn">文档</a></li>
                <li ><a href="/cases-cn">案例</a></li>
                <li class="sel"><a href="/blog-cn">博客</a></li>
                <li ><a href="/about-cn">关于</a></li>
                <li><a class="link-download" href="/docs-cn/QUICKSTART/">下载</a></li>
                </ul>
            </div>
            <div class="global-search">
                <div class="search-wrapper">
                <span class="icon-search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 67.125 67.125"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"/><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"/></svg></span>
                <input data-lang="cn" type="search" id="search-input" placeholder="Search...">
                </div>
            </div>
        </div>
        <div class="nav-btn nav-slider">
            <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 459 459"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"/></svg></i>
        </div>
    </div>
</header>



<nav class="mobile-sidebar">
    <div class="nav-header">
        <div class="logo-wrap">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        </div>
    </div>
    <ul class="ul-base">
        <li ><a href="/docs-cn">文档</a></li>
        <li ><a href="/cases-cn">案例</a></li>
        <li class="sel"><a href="/blog-cn">博客</a></li>
        <li ><a href="/about-cn">关于</a></li>
        <li><a class="link-download" href="/docs-cn/QUICKSTART/">下载</a></li>
    </ul>
    <div class="nav-footer">
        <div class="contact-list-wrap">
        <div class="flex-list">
            <h4 class="list-title"><strong>Contact</strong></h4>
            <ul class="social social-cn ul-base">
            <li><a href="https://twitter.com/PingCAP" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="18"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg></a></li>
            <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg></a></li>
            <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg></a></li>
            <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="18"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg></a></li>
            <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg></a></li>
            <li id="wechat-mobile"><a class="wechat" href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg></a><div class="qr_code_outer f-hide f-tc">
    <div class="qr_code">
        <i id="close_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
        <img id="js_qr_code_img" class="qr_code_img" src="https://download.pingcap.com/images/wechat-qrcode.jpg">
        <p>微信扫一扫<br> 微信ID：pingcap2015</p>
    </div>
</div>
</li>
            </ul>
        </div>
        <div class="subscribe">
<style type="text/css" media="screen">
    #mc_embed_signup .response {
        margin-top: 12px;
        line-height: 1.4;
        font-size: 0.65rem;
    }
</style>
<div id="mc_embed_signup">
    <form action="//pingcap.us16.list-manage.com/subscribe/post?u=ab57beb8a88391cf6193c1b48&amp;id=7c67af4f9d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div id="mc_embed_signup_scroll">
            <div class="form-inline">
                <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-control" placeholder="Subscribe to our newsletter">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-subscribe f-tc">
            </div>
            <div id="mce-responses" class="clear">
                <div class="response" id="mce-error-response" style="display: none;"></div>
                <div class="response" id="mce-success-response" style="display: none;"></div>
            </div>
            
            <div style="position: absolute; left: -5000px;" aria-hidden="true">
                <input type="text" name="b_ab57beb8a88391cf6193c1b48_7c67af4f9d" tabindex="-1" value="">
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" src="https://download.pingcap.com/js/mc-validate.js"></script>
<script type='text/javascript'>
;(function($) {
    window.fnames = new Array()
    window.ftypes = new Array()
    fnames[0] = 'EMAIL'
    ftypes[0] = 'email'
    fnames[1] = 'FNAME'
    ftypes[1] = 'text'
    fnames[2] = 'LNAME'
    ftypes[2] = 'text'
})(jQuery)
var $mcj = jQuery.noConflict(true)
</script>

</div>
        </div>
        <div class="container">
        <a href="/blog" class="btn-lang" id="lang">English</a>
        </div>
    </div>
</nav>

<div class="blog">
        <div class="container">
<div class="sidebar nav-tags" data-type="single"><div class="title">热门标签<a class="rss" href="/blog-cn/index.xml" title="RSS Feed"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="17" viewBox="0 0 402.041 402.04"><g fill="#3A59F0"><path d="M54.816 292.382c-15.229 0-28.169 5.331-38.831 15.988C5.33 319.026 0 331.969 0 347.197c0 15.232 5.325 28.172 15.985 38.828 10.662 10.657 23.606 15.988 38.831 15.988 15.227 0 28.168-5.331 38.828-15.988 10.656-10.656 15.986-23.596 15.986-38.828 0-15.229-5.33-28.171-15.986-38.827-10.657-10.657-23.598-15.988-38.828-15.988zM181.01 221.002c-21.51-21.698-46.158-38.97-73.948-51.816-27.79-12.85-56.914-20.511-87.366-22.985h-1.425c-4.949 0-9.042 1.619-12.275 4.854C1.997 154.477 0 158.953 0 164.472v38.543c0 4.757 1.569 8.85 4.708 12.279 3.14 3.429 7.089 5.332 11.848 5.708 43.586 4.189 80.845 21.752 111.773 52.678 30.93 30.926 48.49 68.187 52.677 111.771.382 4.764 2.284 8.712 5.712 11.847 3.427 3.148 7.517 4.72 12.275 4.72h38.545c5.517 0 9.989-1.995 13.415-5.996 3.621-3.812 5.236-8.381 4.863-13.709-2.478-30.447-10.14-59.573-22.987-87.361-12.846-27.792-30.121-52.438-51.819-73.95z"/><path d="M367.728 239.701c-20.365-45.585-48.345-86.078-83.936-121.482-35.405-35.594-75.896-63.572-121.485-83.939C116.723 13.917 68.996 2.494 19.126.02h-.855c-4.949 0-9.136 1.713-12.563 5.14C1.903 8.583 0 12.964 0 18.294v40.825c0 4.76 1.667 8.897 4.996 12.419 3.33 3.523 7.373 5.376 12.132 5.57 40.924 2.478 79.799 12.188 116.63 29.127 36.83 16.94 68.806 38.972 95.93 66.09 27.118 27.123 49.149 59.101 66.089 95.931 16.94 36.836 26.557 75.705 28.839 116.627.195 4.764 2.046 8.809 5.564 12.139 3.524 3.329 7.762 4.999 12.71 4.999h40.823c5.331 0 9.701-1.902 13.134-5.715 3.809-3.806 5.517-8.274 5.144-13.415-2.471-49.874-13.898-97.6-34.263-143.19z"/></g></svg></a></div><a href="#" class="tag all">ALL (81)</a>
    <div class="tag-list"><a href="#Binlog" class="tag " data-tag="Binlog">Binlog&nbsp;(2)
                </a><a href="#Contributor" class="tag " data-tag="Contributor">Contributor&nbsp;(2)
                </a><a href="#MVCC" class="tag " data-tag="MVCC">MVCC&nbsp;(2)
                </a><a href="#PD" class="tag sel" data-tag="PD">PD&nbsp;(4)
                </a><a href="#Raft" class="tag " data-tag="Raft">Raft&nbsp;(10)
                </a><a href="#RocksDB" class="tag " data-tag="RocksDB">RocksDB&nbsp;(2)
                </a><a href="#Rust" class="tag " data-tag="Rust">Rust&nbsp;(2)
                </a><a href="#SQL" class="tag " data-tag="SQL">SQL&nbsp;(3)
                </a><a href="#Spanner" class="tag " data-tag="Spanner">Spanner&nbsp;(2)
                </a><a href="#TiDB" class="tag " data-tag="TiDB">TiDB&nbsp;(52)
                </a><a href="#TiKV" class="tag sel" data-tag="TiKV">TiKV&nbsp;(18)
                </a><a href="#TiSpark" class="tag " data-tag="TiSpark">TiSpark&nbsp;(2)
                </a><a href="#gRPC" class="tag " data-tag="gRPC">gRPC&nbsp;(2)
                </a><a href="#%e4%ba%8b%e5%8a%a1" class="tag " data-tag="事务">事务&nbsp;(2)
                </a><a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e6%b5%8b%e8%af%95" class="tag " data-tag="分布式系统测试">分布式系统测试&nbsp;(3)
                </a><a href="#%e5%b7%a5%e5%85%b7" class="tag " data-tag="工具">工具&nbsp;(4)
                </a><a href="#%e6%80%a7%e8%83%bd" class="tag " data-tag="性能">性能&nbsp;(2)
                </a><a href="#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96" class="tag " data-tag="性能优化">性能优化&nbsp;(2)
                </a><a href="#%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" class="tag " data-tag="数据同步">数据同步&nbsp;(2)
                </a><a href="#%e6%9e%b6%e6%9e%84" class="tag " data-tag="架构">架构&nbsp;(3)
                </a><a href="#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90" class="tag sel" data-tag="源码解析">源码解析&nbsp;(5)
                </a><a href="#%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag " data-tag="源码阅读">源码阅读&nbsp;(19)
                </a><a href="#%e7%a4%be%e5%8c%ba" class="tag " data-tag="社区">社区&nbsp;(2)
                </a><a href="#%e9%9b%86%e7%be%a4%e8%b0%83%e5%ba%a6" class="tag sel" data-tag="集群调度">集群调度&nbsp;(2)
                </a>
    </div>
</div>
<div class="archive">
                <div class="content markdown-body">
                    <h1 class="title">TiKV 源码解析系列 - Placement Driver</h1>
                    <ul class="blog-post-meta">
                        <li class="meta-item">
                            <img src="/images/svgs/icon-date.svg">Sun, Jan 8, 2017</li>
                        <li class="meta-item">
                            <img src="/images/svgs/icon-writer.svg">唐刘</li>
                    </ul>
                    <div class="blog-text">

<h2 id="介绍">介绍</h2>

<p>Placement Driver (后续以 PD 简称) 是 TiDB 里面全局中心总控节点，它负责整个集群的调度，负责全局 ID 的生成，以及全局时间戳 TSO 的生成等。PD 还保存着整个集群 TiKV 的元信息，负责给 client 提供路由功能。</p>

<p>作为中心总控节点，PD 通过集成 <a href="https://github.com/coreos/etcd">etcd</a> ，自动的支持 auto failover，无需担心单点故障问题。同时，PD 也通过 etcd 的 raft，保证了数据的强一致性，不用担心数据丢失的问题。</p>

<p>在架构上面，PD 所有的数据都是通过 TiKV 主动上报获知的。同时，PD 对整个 TiKV 集群的调度等操作，也只会在 TiKV 发送 heartbeat 命令的结果里面返回相关的命令，让 TiKV 自行去处理，而不是主动去给 TiKV 发命令。这样设计上面就非常简单，我们完全可以认为 PD 是一个无状态的服务（当然，PD 仍然会将一些信息持久化到 etcd），所有的操作都是被动触发，即使 PD 挂掉，新选出的 PD leader 也能立刻对外服务，无需考虑任何之前的中间状态。</p>

<h2 id="初始化">初始化</h2>

<p>PD 集成了 etcd，所以通常，我们需要启动至少三个副本，才能保证数据的安全。现阶段 PD 有集群启动方式，<code>initial-cluster</code> 的静态方式以及 <code>join</code> 的动态方式。</p>

<p>在继续之前，我们需要了解下 etcd 的端口，在 etcd 里面，默认要监听 2379 和 2380 两个端口。2379 主要是 etcd 用来处理外部请求用的，而 2380 则是 etcd peer 之间相互通信用的。</p>

<p>假设现在我们有三个 pd，分别为 pd1，pd2，pd3，分别在 host1，host2，host3 上面。</p>

<p>对于静态初始化，我们直接在三个 PD 启动的时候，给 <code>initial-cluster</code> 设置 <code>pd1=http://host1:2380,pd2=http://host2:2380,pd3=http://host3:2380</code>。</p>

<p>对于动态初始化，我们先启动 pd1，然后启动 pd2，加入到 pd1 的集群里面，<code>join</code> 设置为 <code>pd1=http://host1:2379</code>。然后启动 pd3，加入到 pd1，pd2 形成的集群里面， <code>join</code> 设置为 <code>pd1=http://host1:2379</code>。</p>

<p>可以看到，静态初始化和动态初始化完全走的是两个端口，而且这两个是互斥的，也就是我们只能使用一种方式来初始化集群。etcd 本身只支持 <code>initial-cluster</code> 的方式，但为了方便，PD 同时也提供了 <code>join</code> 的方式。</p>

<p><code>join</code> 主要是用了 etcd 自身提供的 member 相关 API，包括 add member，list member 等，所以我们使用 2379 端口，因为需要将命令发到 etcd 去执行。而 <code>initial-cluster</code> 则是 etcd 自身的初始化方式，所以使用的 2380 端口。</p>

<p>相比于 <code>initial-cluster</code>，<code>join</code> 需要考虑非常多的 case（在 <code>server/join.go</code> <code>prepareJoinCluster</code> 函数里面有详细的解释），但 <code>join</code> 的使用非常自然，后续我们会考虑去掉 <code>initial-cluster</code> 的初始化方案。</p>

<h2 id="选举">选举</h2>

<p>当 PD 启动之后，我们就需要选出一个 leader 对外提供服务。虽然 etcd 自身也有 raft leader，但我们还是觉得使用自己的 leader，也就是 PD 的 leader 跟 etcd 自己的 leader 是不一样的。</p>

<p>当 PD 启动之后，Leader 的选举如下：</p>

<ol>
<li>检查当前集群是不是有 leader，如果有 leader，就 watch 这个 leader，只要发现 leader 掉了，就重新开始 1。</li>

<li><p>如果没有 leader，开始 campaign，创建一个 Lessor，并且通过 etcd 的事务机制写入相关信息，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Create a lessor.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Ctx</span>(), <span style="color:#a6e22e">requestTimeout</span>)
<span style="color:#a6e22e">leaseResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lessor</span>.<span style="color:#a6e22e">Grant</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">LeaderLease</span>)
<span style="color:#a6e22e">cancel</span>()

<span style="color:#75715e">// The leader key must not exist, so the CreateRevision is 0.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">txn</span>().
    <span style="color:#a6e22e">If</span>(<span style="color:#a6e22e">clientv3</span>.<span style="color:#a6e22e">Compare</span>(<span style="color:#a6e22e">clientv3</span>.<span style="color:#a6e22e">CreateRevision</span>(<span style="color:#a6e22e">leaderKey</span>), <span style="color:#e6db74">&#34;=&#34;</span>, <span style="color:#ae81ff">0</span>)).
    <span style="color:#a6e22e">Then</span>(<span style="color:#a6e22e">clientv3</span>.<span style="color:#a6e22e">OpPut</span>(<span style="color:#a6e22e">leaderKey</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">leaderValue</span>, <span style="color:#a6e22e">clientv3</span>.<span style="color:#a6e22e">WithLease</span>(<span style="color:#a6e22e">clientv3</span>.<span style="color:#a6e22e">LeaseID</span>(<span style="color:#a6e22e">leaseResp</span>.<span style="color:#a6e22e">ID</span>)))).
    <span style="color:#a6e22e">Commit</span>()</code></pre></div>
<p>如果 leader key 的 CreateRevision 为 0，表明其他 PD 还没有写入，那么我就可以将我自己的 leader 相关信息写入，同时会带上一个 Lease。如果事务执行失败，表明其他的 PD 已经成为了 leader，那么就重新回到 1。</p></li>

<li><p>成为 leader 之后，我们对定期进行保活处理:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Make the leader keepalived.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">ch</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lessor</span>.<span style="color:#a6e22e">KeepAlive</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Ctx</span>(), <span style="color:#a6e22e">clientv3</span>.<span style="color:#a6e22e">LeaseID</span>(<span style="color:#a6e22e">leaseResp</span>.<span style="color:#a6e22e">ID</span>))
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
}</code></pre></div>
<p>当 PD 崩溃，原先写入的 leader key 会因为 lease 到期而自动删除，这样其他的 PD 就能 watch 到，重新开始选举。</p></li>

<li><p>初始化 raft cluster，主要是从 etcd 里面重新载入集群的元信息。拿到最新的 TSO 信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Try to create raft cluster.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">createRaftCluster</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
}

<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;sync timestamp for tso&#34;</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">syncTimestamp</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
}</code></pre></div></li>

<li><p>所有做完之后，开始定期更新 TSO，监听 lessor 是否过期，以及外面是否主动退出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> {
    <span style="color:#66d9ef">select</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;keep alive channel is closed&#34;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">tsTicker</span>.<span style="color:#a6e22e">C</span>:
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">updateTimestamp</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
        }
    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Ctx</span>().<span style="color:#a6e22e">Done</span>():
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;server closed&#34;</span>)
    }
}</code></pre></div></li>
</ol>

<h3 id="tso">TSO</h3>

<p>前面我们说到了 TSO，TSO 是一个全局的时间戳，它是 TiDB 实现分布式事务的基石。所以对于 PD 来说，我们首先要保证它能快速大量的为事务分配 TSO，同时也需要保证分配的 TSO 一定是单调递增的，不可能出现回退的情况。</p>

<p>TSO 是一个 int64 的整形，它由 physical time + logical time 两个部分组成。Physical time 是当前 unix time 的毫秒时间，而 logical time 则是一个最大 <code>1 &lt;&lt; 18</code> 的计数器。也就是说 1ms，PD 最多可以分配 262144 个 TSO，这个能满足绝大多数情况了。</p>

<p>对于 TSO 的保存于分配，PD 会做如下处理：</p>

<ol>
<li><p>当 PD 成为 leader 之后，会从 etcd 上面获取上一次保存的时间，如果发现本地的时间比这个大，则会继续等待直到当前的时间大于这个值：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">last</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">loadTimestamp</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">now</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>

<span style="color:#66d9ef">for</span> {
    <span style="color:#a6e22e">now</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">wait</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">last</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">now</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">updateTimestampGuard</span>; <span style="color:#a6e22e">wait</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;wait %v to guarantee valid generated timestamp&#34;</span>, <span style="color:#a6e22e">wait</span>)
        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">wait</span>)
        <span style="color:#66d9ef">continue</span>
    }
    <span style="color:#66d9ef">break</span>
}</code></pre></div></li>

<li><p>当 PD 能分配 TSO 之后，首先会向 etcd 申请一个最大的时间，譬如，假设当前时间是 t1，每次最多能申请 3s 的时间窗口，PD 会向 etcd 保存 t1 + 3s 的时间值，然后 PD 就能在内存里面直接使用这一段时间窗口.当当前的时间 t2 大于 t1 + 3s 之后，PD 就会在向 etcd 继续更新为 t2 + 3s：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">lastSavedTime</span>) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> {
    <span style="color:#a6e22e">last</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">lastSavedTime</span>
    <span style="color:#a6e22e">save</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">TsoSaveInterval</span>.<span style="color:#a6e22e">Duration</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">saveTimestamp</span>(<span style="color:#a6e22e">save</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">err</span>)
    }
}</code></pre></div>
<p>这么处理的好处在于，即使 PD 当掉，新启动的 PD 也会从上一次保存的最大的时间之后开始分配 TSO，也就是 1 处理的情况。</p></li>

<li><p>因为 PD 在内存里面保存了一个可分配的时间窗口，所以外面请求 TSO 的时候，PD 能直接在内存里面计算 TSO 并返回。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pdpb</span>.<span style="color:#a6e22e">Timestamp</span>{}
<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">maxRetryCount</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
    <span style="color:#a6e22e">current</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ts</span>.<span style="color:#a6e22e">Load</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">atomicObject</span>)
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;we haven&#39;t synced timestamp ok, wait and retry, retry count %d&#34;</span>, <span style="color:#a6e22e">i</span>)
        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">200</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
        <span style="color:#66d9ef">continue</span>
    }

    <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Physical</span> = <span style="color:#a6e22e">current</span>.<span style="color:#a6e22e">physical</span>.<span style="color:#a6e22e">UnixNano</span>() <span style="color:#f92672">/</span> int64(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
    <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Logical</span> = <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt64</span>(<span style="color:#960050;background-color:#1e0010">¤</span><span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">logical</span>, int64(<span style="color:#a6e22e">count</span>))
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Logical</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">maxLogical</span> {

        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">updateTimestampStep</span>)
        <span style="color:#66d9ef">continue</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resp</span>, <span style="color:#66d9ef">nil</span>
}</code></pre></div>
<p>因为是在内存里面计算的，所以性能很高，我们自己内部测试每秒能分配百万级别的 TSO。</p></li>

<li><p>如果 client 每次事务都向 PD 来请求一次 TSO，每次 RPC 的开销也是非常大的，所以 client 会批量的向 PD 获取 TSO。client 会首先收集一批事务的 TSO 请求，譬如 n 个，然后直接向 PD 发送命令，参数就是 n，PD 收到命令之后，会生成 n 个 TSO 返回给客户端。</p></li>
</ol>

<h2 id="心跳">心跳</h2>

<p>在最开始我们说过，PD 所有关于集群的数据都是由 TiKV 主动心跳上报的，PD 对 TiKV 的调度也是在心跳的时候完成的。通常 PD 会处理两种心跳，一个是 TiKV 自身 store 的心跳，而另一个则是 store 里面 region 的 leader peer 上报的心跳。</p>

<p>对于 store 的心跳，PD 在 <code>handleStoreHeartbeat</code> 函数里面处理，主要就是将心跳里面当前的 store 的一些状态缓存到 cache 里面。store 的状态包括该 store 有多少个 region，有多少个 region 的 leader peer 在该 store 上面等，这些信息都会用于后续的调度。</p>

<p>对于 region 的心跳，PD 在 <code>handleRegionHeartbeat</code> 里面处理。这里需要注意，只有 leader peer 才会去上报所属 region 的信息，follower peer 是不会上报的。收到 region 的心跳之后，首先 PD 也会将其放入 cache 里面，如果 PD 发现 region 的 epoch 有变化，就会将这个 region 的信息也保存到 etcd 里面。然后，PD 会对这个 region 进行具体的调度，譬如发现 peer 数目不够，添加新的 peer，或者有一个 peer 已经坏了，删除这个 peer 等，详细的调度实现，我们会在后续讨论。</p>

<p>这里再说一下 region 的 epoch，在 region 的 epoch 里面，有 <code>conf_ver</code> 和 <code>version</code>，分别表示这个 region 不同的版本状态。如果一个 region 发生了 membership changes，也就是新增或者删除了 peer，<code>conf_ver</code> 会加 1，如果 region 发生了 <code>split</code> 或者 <code>merge</code>，则 <code>version</code> 加 1。</p>

<p>无论是 PD 还是在 TiKV，我们都是通过 epoch 来判断 region 是否发生了变化，从而拒绝掉一些危险的操作。譬如 region 已经发生了分裂，<code>version</code> 变成了 2，那么如果这时候有一个写请求带上的 <code>version</code> 是 1， 我们就会认为这个请求是 stale，会直接拒绝掉。因为 <code>version</code> 变化表明 region 的范围已经发生了变化，很有可能这个 stale 的请求需要操作的 key 是在之前的 region range 里面而没在新的 range 里面。</p>

<h2 id="split-merge">Split / Merge</h2>

<p>前面我们说了，PD 会在 region 的 heartbeat 里面对 region 进行调度，然后直接在 heartbeat 的返回值里面带上相关的调度信息，让 TiKV 自己去处理，TiKV 处理完成之后，通过下一个 heartbeat 重新上报，PD 就能知道是否调度成功了。</p>

<p>对于 membership changes，比较容易，因为我们有最大副本数的配置，假设三个，那么当 region 的心跳上来，发现只有两个 peer，那么就 add peer，如果有四个 peer，就 remove peer。而对于 region 的 split / merge，则情况稍微要复杂一点，但也比较简单。注意，现阶段，我们只支持 split，merge 处于开发阶段，没对外发布，所以这里仅仅以 split 举例：</p>

<ol>
<li>在 TiKV 里面，leader peer 会定期检查 region 所占用的空间是否超过某一个阀值，假设我们设置 region 的 size 为 64MB，如果一个 region 超过了 96MB， 就需要分裂。</li>
<li>Leader peer 会首先向 PD 发送一个请求分裂的命令，PD 在 <code>handleAskSplit</code> 里面处理，因为我们是一个 region 分裂成两个，对于这两个新分裂的 region，一个会继承之前 region 的所有的元信息，而另一个相关的信息，譬如 region ID，新的 peer ID，则需要 PD 生成，并将其返回给 leader。</li>
<li>Leader peer 写入一个 split raft log，在 apply 的时候执行，这样 region 就分裂成了两个。</li>
<li>分裂成功之后，TiKV 告诉 PD，PD 就在 <code>handleReportSplit</code> 里面处理，更新 cache 相关的信息，并持久化到 etcd。</li>
</ol>

<h2 id="路由">路由</h2>

<p>因为 PD 保存了所有 TiKV 的集群信息，自然对 client 提供了路由的功能。假设 client 要对 <code>key</code> 写入一个值。</p>

<ol>
<li>client 先从 PD 获取 <code>key</code> 属于哪一个 region，PD 将这个 region 相关的元信息返回。</li>
<li>client 自己 cache，这样就不需要每次都从 PD 获取。然后直接给 region 的 leader peer 发送命令。</li>
<li>有可能 region 的 leader 已经漂移到其他 peer，TiKV 会返回 <code>NotLeader</code> 错误，并带上新的 leader 的地址，client 在 cache 里面更新，并重新向新的 leader 发送请求。</li>
<li>也有可能 region 的 version 已经变化，譬如 split 了，这时候，<code>key</code> 可能已经落入了新的 region 上面，client 会收到 <code>StaleCommand</code> 的错误，于是重新从 PD 获取，进入状态 1。</li>
</ol>

<h2 id="小结">小结</h2>

<p>PD 作为 TiDB 集群的中心调度模块，在设计上面，我们尽量保证无状态，方便扩展。本篇文章主要介绍了 PD 是如何跟 TiKV，TiDB 协作交互的。后面，我们会详细地介绍核心调度功能，也就是 PD 是如何控制整个集群的。</p>
</div>
                </div><div class="ssba-wrap">
    <div class="ssba">
        <a class="ssba_mail_share" href="mailto:info@pingcap.com">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" width="18" height="18"><path d="M7 9L5.268 7.484.316 11.729c.18.167.423.271.691.271h11.986c.267 0 .509-.104.688-.271L8.732 7.484 7 9z"/><path d="M13.684 2.271A1.007 1.007 0 0 0 12.993 2H1.007c-.267 0-.509.104-.689.273L7 8l6.684-5.729zM0 2.878v8.308l4.833-4.107zM9.167 7.079L14 11.186V2.875z"/></svg>
        </a>
        <a id="wechat_share_btn" data-site="wechat" data-url="https://pingcap.com/blog-cn/placement-driver/" class="ssba_wechat_share" href="javascript:void(0)" onclick="toggleBlogQRCode()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg>
        </a>
    </div>
</div>

<style type="text/css">
    .fixed-qrcode {
        position: fixed;
        top: 120px;
        right: 105px;
        padding: 10px 15px;
        width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        text-align: center;
    }

    .fixed-qrcode p {
        font-size: 14px;
        font-weight: 300;
        line-height: 1.6;
        margin: 8px 0;
        color: #333;
    }

    .fixed-qrcode #close_share_qrcode {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        padding: 10px;
    }

    .fixed-qrcode #close_share_qrcode svg {
        display: block;
    }

    .f-hide #share_qrcode {
        visibility: hidden;
        opacity: 0;
    }

    .fixed-qrcode #share_qrcode {
        visibility: visible;
        opacity: 1;
        height: 128px;
        transition: visibility 0s linear 0s, opacity .3s 0s;
        -webkit-transition: visibility 0s linear 0s, opacity .3s 0s;
    }

    #share_qrcode img {
        margin: 0 auto;
    }
</style>
<div id="share_qrcode_outer" class="f-hide">
    <i id="close_share_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
    <p>分享到微信</p>
    <div id="share_qrcode"></div>
    <p>打开微信，使用 “扫一扫” 即可将网页分享至朋友圈。</p>
</div>

<script type="text/javascript" src="/js/vendor/qrcode.min.js"></script>
<script type="text/javascript">
    window.onload = function() {
        var close_share_qrcode_btn = document.getElementById('close_share_qrcode')
        var wechat_share_btn = document.getElementById('wechat_share_btn')
        var blog_url = wechat_share_btn.getAttribute('data-url')

        window.pingcap_blog_qrcode = new QRCode(
            document.getElementById('share_qrcode'),
            {
            text: blog_url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
            }
        )

        close_share_qrcode_btn.addEventListener('click', function(event) {
            document
            .getElementById('share_qrcode_outer')
            .setAttribute('class', 'f-hide')
        })
    }

    function toggleBlogQRCode() {
        var qrcode_wrapper = document.getElementById('share_qrcode_outer')

        if (qrcode_wrapper.getAttribute('class') == 'f-hide') {
            qrcode_wrapper.setAttribute('class', 'fixed-qrcode')
        } else {
            qrcode_wrapper.setAttribute('class', 'f-hide')
        }
    }
</script>
</div>
        </div>
    </div>
<footer>
    <div class="container">
        <div class="flex-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>产品</strong></h4>
                <ul>
                <li><a href="/docs-cn/">TiDB</a></li>
                <li><a href="/docs-cn/tispark/tispark-user-guide/">TiSpark</a></li>
                <li><a href="/docs-cn/ROADMAP/">TiDB 路线图</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>文档</strong></h4>
                <ul>
                <li><a href="/docs-cn/QUICKSTART/">快速入门</a></li>
                <li><a href="/blog-cn/tidb-best-practice/">最佳实践</a></li>
                <li><a href="/docs-cn/FAQ/">常见问题解答</a></li>
                <li><a href="/docs-cn/tools/syncer/">TiDB 周边工具</a></li>
                <li><a href="/docs-cn/releases/rn/">版本发布说明</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>资源</strong></h4>
                <ul>
                <li><a href="/blog-cn/">博客</a></li>
                <li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
                <li><a href="https://zhuanlan.zhihu.com/newsql" target="_blank">知乎专栏</a></li>
                
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>公司</strong></h4>
                <ul>
                <li><a href="/about-cn/">关于我们</a></li>
                <li><a href="/recruit-cn/">招贤纳士</a></li>
                <li><a href="/news-cn/">新闻报道</a></li>
                </ul>
            </div>
        </div>
        <div class="contact-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>联系我们</strong></h4>
                <ul>
                <li><a href="https://twitter.com/PingCAP" class="twitter"  target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="18"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg> Twitter</a></li>
                <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg> LinkedIn</a></li>
                <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg> Reddit</a></li>
                <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="18"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg> Google Group</a></li>
                <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg> Stack Overflow</a></li>
                <li id="wechat"><a class="wechat" href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg> 微信公众号</a> <div class="qr_code_outer f-hide f-tc">
    <div class="qr_code">
        <i id="close_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
        <img id="js_qr_code_img" class="qr_code_img" src="https://download.pingcap.com/images/wechat-qrcode.jpg">
        <p>微信扫一扫<br> 微信ID：pingcap2015</p>
    </div>
</div>
</li>
                </ul>
            </div>
            <div class="subscribe">
<style type="text/css" media="screen">
    #mc_embed_signup .response {
        margin-top: 12px;
        line-height: 1.4;
        font-size: 0.65rem;
    }
</style>
<div id="mc_embed_signup">
    <form action="//pingcap.us16.list-manage.com/subscribe/post?u=ab57beb8a88391cf6193c1b48&amp;id=7c67af4f9d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div id="mc_embed_signup_scroll">
            <div class="form-inline">
                <input type="email" value="" name="EMAIL" id="mce-EMAIL" class="form-control" placeholder="Subscribe to our newsletter">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-subscribe f-tc">
            </div>
            <div id="mce-responses" class="clear">
                <div class="response" id="mce-error-response" style="display: none;"></div>
                <div class="response" id="mce-success-response" style="display: none;"></div>
            </div>
            
            <div style="position: absolute; left: -5000px;" aria-hidden="true">
                <input type="text" name="b_ab57beb8a88391cf6193c1b48_7c67af4f9d" tabindex="-1" value="">
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" src="https://download.pingcap.com/js/mc-validate.js"></script>
<script type='text/javascript'>
;(function($) {
    window.fnames = new Array()
    window.ftypes = new Array()
    fnames[0] = 'EMAIL'
    ftypes[0] = 'email'
    fnames[1] = 'FNAME'
    ftypes[1] = 'text'
    fnames[2] = 'LNAME'
    ftypes[2] = 'text'
})(jQuery)
var $mcj = jQuery.noConflict(true)
</script>

</div>
        </div>
    </div>
    <div class="container copyright-container">
        <p class="copyright">&copy; 2018 北京平凯星辰科技发展有限公司</p>
        <a href="/blog" class="copyright-btn-lang" id="lang">English</a>
    </div>
</footer>
<button class="back-to-top" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 284.929 284.929"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"/></svg>
</button>
</div>
<script type="text/javascript">document.getElementById("page-loader").style.display="none",document.getElementById("page-content").style.display="block"</script>
<div class="overlay"></div>
<script src="https://download.pingcap.com/js/jquery.min.js"></script><script type="text/javascript" src="/js/doc.js"></script><script type="text/javascript"src="https://download.pingcap.com/js/docsearch.min.js"></script>
<script type="text/javascript"src="/js/app.js"></script></body>
</html>
